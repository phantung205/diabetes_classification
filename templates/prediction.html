{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h1 class="text-center mb-4">Dự đoán Bệnh Tiểu Đường</h1>

            <!-- Model Selection -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Chọn Model Dự đoán</h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label for="model" class="form-label">Model hiện tại: <strong>{{ current_model.replace('_',
                                    ' ').title() if current_model else 'logistic' }}</strong></label>
                            <select class="form-select" id="model" name="model">
                                {% for model in models %}
                                <option value="{{ model }}" {% if model==current_model %}selected{% endif %}>{{
                                    model.replace('_', ' ').title() }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" name="change_model" class="btn btn-primary w-100">Thay đổi
                                Model</button>
                        </div>
                    </form>
                    {% if model_change_message %}
                    <div class="mt-3 alert alert-success">
                        {{ model_change_message }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Manual Input -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Nhập Dữ liệu Dự đoán</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="manual-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="Pregnancies" class="form-label">Số lần mang thai</label>
                                <input type="number" step="1" class="form-control" id="Pregnancies" name="Pregnancies"
                                    value="{{ form_data.get('Pregnancies', '') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="Glucose" class="form-label">Glucose</label>
                                <input type="number" step="0.1" class="form-control" id="Glucose" name="Glucose"
                                    value="{{ form_data.get('Glucose', '') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="BloodPressure" class="form-label">Huyết áp</label>
                                <input type="number" step="0.1" class="form-control" id="BloodPressure"
                                    name="BloodPressure" value="{{ form_data.get('BloodPressure', '') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="SkinThickness" class="form-label">Độ dày da</label>
                                <input type="number" step="0.1" class="form-control" id="SkinThickness"
                                    name="SkinThickness" value="{{ form_data.get('SkinThickness', '') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="Insulin" class="form-label">Insulin</label>
                                <input type="number" step="0.1" class="form-control" id="Insulin" name="Insulin"
                                    value="{{ form_data.get('Insulin', '') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="BMI" class="form-label">BMI</label>
                                <input type="number" step="0.1" class="form-control" id="BMI" name="BMI"
                                    value="{{ form_data.get('BMI', '') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="DiabetesPedigreeFunction" class="form-label">Hàm Pedigree Bệnh Đái Tháo
                                    Đường</label>
                                <input type="number" step="0.001" class="form-control" id="DiabetesPedigreeFunction"
                                    name="DiabetesPedigreeFunction"
                                    value="{{ form_data.get('DiabetesPedigreeFunction', '') }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="Age" class="form-label">Tuổi</label>
                                <input type="number" step="1" class="form-control" id="Age" name="Age"
                                    value="{{ form_data.get('Age', '') }}" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" name="predict_manual" class="btn btn-success">Dự đoán</button>
                        </div>
                    </form>
                    {% if prediction is not none %}
                    <div class="mt-3 card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">Kết quả Dự đoán</h6>
                        </div>
                        <div class="card-body">
                            {% if used_model %}
                            <p><strong>Model đã sử dụng:</strong> {{ used_model.replace('_', ' ').title() }}</p>
                            {% endif %}
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Dự đoán:</h6>
                                    <p class="h4 {% if prediction == 1 %}text-danger{% else %}text-success{% endif %}">
                                        {{ 'Có bệnh tiểu đường' if prediction == 1 else 'Không có bệnh tiểu đường' }}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Xác suất:</h6>
                                    <ul class="list-unstyled">
                                        {% for cls, prob in proba_dict.items() %}
                                        <li><strong>{{ cls }}:</strong> {{ prob }}%</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- File Upload -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Upload File Dự đoán</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Upload file CSV hoặc Excel chứa dữ liệu để dự đoán hàng loạt. File phải có các
                        cột: Pregnancies, Glucose, BloodPressure, SkinThickness, Insulin, BMI, DiabetesPedigreeFunction,
                        Age</p>
                    <form method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Chọn file</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".csv,.xlsx,.xls"
                                required>
                        </div>
                        <button type="submit" name="predict_file" class="btn btn-success">Upload và Dự đoán</button>
                    </form>
                    {% if file_message %}
                    <div class="mt-3 alert alert-info">
                        {{ file_message }}
                    </div>
                    {% endif %}
                    {% if show_download_button and file_result_path %}
                    <div class="mt-3">
                        <a href="{{ url_for('download_file', filename=file_result_path.split('\\')[-1]) }}"
                            class="btn btn-primary">Download Kết Quả</a>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

    </div>
</div>
</div>
{% endblock %}